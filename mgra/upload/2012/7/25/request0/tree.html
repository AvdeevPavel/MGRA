<!DOCTYPE html><html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>MGRA tree</title><style type="text/css">
	.end0{color:green}
	.end1{color:red}
	.end2{color:lime}
	.end3{color:maroon}
</style><script src="http://www.kineticjs.com/download/kinetic-v3.10.4.js"></script><script>
	var values =  [
		
	'12',

	'34',

	'1',

	'2',

	'3',

	'4',

	]
				
	var trees = [ 
		
	[
		
   	[
		
	{	
		viewRect: null, 
		arrows: null,
  		leftChildNumber: 0,
		rightChildNumber: 1,
		text: "12"
	},

	{	
		viewRect: null, 
		arrows: null,
  		leftChildNumber: 2,
		rightChildNumber: 3,
		text: "34"
	},

	],

   	[
		
	{	
		viewRect: null, 
		arrows: null,
  		leftChildNumber: -1,
		rightChildNumber: -1,
		text: "1"
	},

	{	
		viewRect: null, 
		arrows: null,
  		leftChildNumber: -1,
		rightChildNumber: -1,
		text: "2"
	},

	{	
		viewRect: null, 
		arrows: null,
  		leftChildNumber: -1,
		rightChildNumber: -1,
		text: "3"
	},

	{	
		viewRect: null, 
		arrows: null,
  		leftChildNumber: -1,
		rightChildNumber: -1,
		text: "4"
	},

	],

	], 

	]

	function getClientWidth() {
		return document.compatMode=='CSS1Compat' && !window.opera?document.documentElement.clientWidth:document.body.clientWidth;
	}
		
	function getClientHeight() {
		return document.compatMode=='CSS1Compat' && !window.opera?document.documentElement.clientHeight:document.body.clientHeight;
	}
					
	function changeStyle(id, show){
		var element = document.getElementById(id);
		if (element != null) {
			element.style.display= id == show ? "" : "none";;
		}
	}

	function createStage(nameContainer, width_, height_) {	
		var stage = new Kinetic.Stage({ 
			container: nameContainer,
			width: width_,  
			height: height_
		});

		stage.on("mouseup", function() {
       		document.body.style.cursor = "default";
       	});
		return stage; 		 
	} 	
			
	function createText(str, color, coorX, coorY, layer) { 
		var text = new Kinetic.Text({
			text: str,	
			x: coorX,
			y: coorY,
			cornerRadius: 5,
			stroke: "black",
			strokeWidth: 2,
			fill: color,
			fontSize: 13,
			padding: 13, 
			fontFamily: "Calibri",
			textFill: "black",
			align: 'center',
			fontStyle: 'italic',
			shadow: {
				color: 'black',
				blur: 1,
				offset: [10, 10],
				alpha: 0.2
			}
		});

		text.on("mouseover", function() { 
			this.setDraggable(true);
			this.setFill("blue");
			layer.draw();
		});	

		text.on("mouseout", function() { 
			this.setDraggable(false);
			if (document.getElementById('gen'+str) != null) {
				this.setFill("yellow");
       		} else {
				this.setFill("#00dddd");
			}
			layer.draw();
		});	

		text.on("mousedown", function() {
       		document.body.style.cursor = "pointer";
       	});

		text.on("dblclick", function(evt) { 
			for (var i = 0; i < values.length; ++i) {
               	changeStyle('trs'+values[i], 'trs'+str);
                 changeStyle('gen'+values[i], 'gen'+str);
            }	
		});
		return text;  
	}

	function createLine(x1, y1, x2, y2, color, strId, strName) { 
		var line = new Kinetic.Line({
			points: [x1, y1, x2, y2],
			stroke: color, 
			lineCap: "round",
			lineJoin: "round", 
			strokeWidth: 4,
			id: strId + "_" + strName,
			name: strName
		});
		return line;
	}

	function createRootArrow(fromX, fromY, toX, toY, text, stage, color) { 
		var group = new Kinetic.Group();
		var headlen = 15;   
		var angle = Math.atan2(fromY - toY, fromX - toX);

		var line1 = new Kinetic.Shape({
         	drawFunc: function(context) {
	      	  context.beginPath();
	       	  context.moveTo(fromX, fromY);
	       	  context.quadraticCurveTo(stage.getWidth() / 2, 5, toX, toY);
	       	  this.stroke(context);
			},
	        stroke: color,
			lineJoin: "round",
			strokeWidth: 4,
			id: "mainLine_" + text,
			name: text
		});

		group.add(line1);				
		group.add(createLine(toX, toY, toX + headlen*Math.cos(angle-Math.PI/6), toY + headlen*Math.sin(angle-Math.PI/6), color, "leftLine", text));
		group.add(createLine(toX, toY, toX + headlen*Math.cos(angle+Math.PI/6), toY + headlen*Math.sin(angle+Math.PI/6), color, "rightLine", text)); 
		return group;
	} 

	function createArrow(fromX, fromY, toX, toY, text, color) { 
		var group = new Kinetic.Group();
		var headlen = 15;   
    	var angle = Math.atan2(fromY - toY, fromX - toX);

		group.add(createLine(fromX, fromY, toX, toY, color, "mainLine", text)); 
		group.add(createLine(fromX, fromY, fromX - headlen*Math.cos(angle-Math.PI/6), fromY - headlen*Math.sin(angle-Math.PI/6), color, "leftLine", text));   
		group.add(createLine(fromX, fromY, fromX - headlen*Math.cos(angle+Math.PI/6), fromY - headlen*Math.sin(angle+Math.PI/6), color, "rightLine", text));   
		return group;
	} 	

	function createNodes(k, stage, layer) {
 		var stepHeight = stage.getHeight() / (trees[k].length + 1); 
		var countInLevel = 2; 

		for(var i = 0; i < trees[k].length; ++i) { 
			countInLevel = countInLevel * 2;
			var stepWidth = 1; 
			for(var j = 0; j < trees[k][i].length; ++j) { 
	     		if (document.getElementById('gen'+trees[k][i][j].text) != null) {
					trees[k][i][j].viewRect = createText(trees[k][i][j].text, "yellow", stepWidth * stage.getWidth() / countInLevel, stepHeight + i * stepHeight, layer);
				} else { 
					trees[k][i][j].viewRect = createText(trees[k][i][j].text, "#00dddd", stepWidth * stage.getWidth() / countInLevel, stepHeight + i * stepHeight, layer);
				} 
				stepWidth += 2;								
			}
		} 

		for(var i = 0; i < trees[k].length; ++i) { 
			for(var j = 0; j < trees[k][i].length; ++j) { 
				layer.add(trees[k][i][j].viewRect);
			} 
		}				
		stage.add(layer);
	}

	function createEdges(k, stage, layer) { 
		for(var i = 0; i < trees[k].length; ++i) { 
			for(var j = 0; j < trees[k][i].length; ++j) { 
				trees[k][i][j].arrows = new Array(3);
			} 
		}
			
		var rootArray = null;
		if (document.getElementById('trs' + trees[k][0][0].text) != null) {
			rootArrow = createRootArrow((trees[k][0][0].viewRect.getX() + trees[k][0][0].viewRect.getBoxWidth()), trees[k][0][0].viewRect.getY(), trees[k][0][1].viewRect.getX(), trees[k][0][1].viewRect.getY(), trees[k][0][0].text, stage, "red");
		} else { 
			rootArrow = createRootArrow((trees[k][0][0].viewRect.getX() + trees[k][0][0].viewRect.getBoxWidth()), trees[k][0][0].viewRect.getY(), trees[k][0][1].viewRect.getX(), trees[k][0][1].viewRect.getY(), trees[k][0][0].text, stage, "black");
		} 
		trees[k][0][0].arrows[0] = rootArrow; 
		trees[k][0][1].arrows[0] = rootArrow;
		
		for(var i = 0; i < trees[k].length; ++i) { 
			for(var j = 0; j < trees[k][i].length; ++j) {
				if (trees[k][i][j].leftChildNumber != -1) {
					var x1 = trees[k][i][j].viewRect.getX();
					var y1 = trees[k][i][j].viewRect.getY() + trees[k][i][j].viewRect.getBoxHeight(); 
					var x2 = trees[k][i + 1][trees[k][i][j].leftChildNumber].viewRect.getX() + trees[k][i + 1][trees[k][i][j].leftChildNumber].viewRect.getBoxWidth() / 2; 
					var y2 = trees[k][i + 1][trees[k][i][j].leftChildNumber].viewRect.getY(); 
					if (document.getElementById('trs' + trees[k][i + 1][trees[k][i][j].leftChildNumber].text) != null) { 
						trees[k][i][j].arrows[1] = createArrow(x1, y1, x2, y2, trees[k][i + 1][trees[k][i][j].leftChildNumber].text, "red");								
					} else { 
						trees[k][i][j].arrows[1] = createArrow(x1, y1, x2, y2, trees[k][i + 1][trees[k][i][j].leftChildNumber].text, "black");							
					} 
					trees[k][i + 1][trees[k][i][j].leftChildNumber].arrows[0] = trees[k][i][j].arrows[1]; 
				} 
								
				if (trees[k][i][j].rightChildNumber != -1) { 
					var x1 = trees[k][i][j].viewRect.getX() + trees[k][i][j].viewRect.getBoxWidth();
					var y1 = trees[k][i][j].viewRect.getY() + trees[k][i][j].viewRect.getBoxHeight(); 
					var x2 = trees[k][i + 1][trees[k][i][j].rightChildNumber].viewRect.getX() + trees[k][i + 1][trees[k][i][j].rightChildNumber].viewRect.getBoxWidth() / 2; 
					var y2 = trees[k][i + 1][trees[k][i][j].rightChildNumber].viewRect.getY(); 												
					if (document.getElementById('trs' + trees[k][i + 1][trees[k][i][j].rightChildNumber].text) != null) { 
						trees[k][i][j].arrows[2] = createArrow(x1, y1, x2, y2, trees[k][i + 1][trees[k][i][j].rightChildNumber].text, "red");								
					} else {
						trees[k][i][j].arrows[2] = createArrow(x1, y1, x2, y2, trees[k][i + 1][trees[k][i][j].rightChildNumber].text, "black");							
					}	
					trees[k][i + 1][trees[k][i][j].rightChildNumber].arrows[0] = trees[k][i][j].arrows[2]; 
				}
			} 
		} 					
							
		for(var i = 0; i < trees[k].length - 1; ++i) { 
			for(var j = 0; j < trees[k][i].length; ++j) { 
				for(var c = 0; c < trees[k][i][j].arrows.length; ++c) { 
					if (trees[k][i][j].arrows[c] != null) { 
						layer.add(trees[k][i][j].arrows[c]);
					} 
				} 
			} 
		}
		stage.add(layer);

		for(var i = 0; i < values.length; ++i) { 
			var line = layer.get('#mainLine_' + values[i])[0];
			if (line != null) { 
				line.saveImageData();
				line.on("dblclick", function(evt) { 
					str = 'trs' + this.getName();
					for (var i = 0; i < values.length; ++i) {
	                	changeStyle('gen'+values[i], str);
						changeStyle('trs'+values[i], str);
                 	}	
				});
			} 		
		}
	} 
		
	function changeLines(i, lines, x1, y1) { 
		if (lines[0] != null) { 
			lines[0].attrs.points[i] ={x: x1, y: y1};				
			lines[0].saveImageData();
			var headlen = 15;   
			var angle = Math.atan2(lines[0].attrs.points[0].y - lines[0].attrs.points[1].y, lines[0].attrs.points[0].x - lines[0].attrs.points[1].x);
			lines[1].setPoints([lines[0].attrs.points[0].x, lines[0].attrs.points[0].y, lines[0].attrs.points[0].x - headlen*Math.cos(angle-Math.PI/6), lines[0].attrs.points[0].y - headlen*Math.sin(angle-Math.PI/6)]);

			lines[2].setPoints([lines[0].attrs.points[0].x, lines[0].attrs.points[0].y, lines[0].attrs.points[0].x - headlen*Math.cos(angle+Math.PI/6), lines[0].attrs.points[0].y - headlen*Math.sin(angle+Math.PI/6)]);						
		} 
	} 

	function createEventDrag(rect, arrows, layer) { 
		rect.on("dragmove dragend", function() {
			if (arrows[0] != null) {
				var lines = arrows[0].getChildren();
				changeLines(1, lines, this.getX() + this.getBoxWidth() / 2, this.getY());
			} 

			if (arrows[1] != null) { 
				var lines = arrows[1].getChildren();
				changeLines(0, lines, this.getX(), this.getY() + this.getBoxHeight());		 		
			} 

			if (arrows[2] != null) { 
				var lines = arrows[2].getChildren();
				changeLines(0, lines, this.getX()+this.getBoxWidth(), this.getY() + this.getBoxHeight());				 
			}  											
			layer.draw();
		});
 	} 

	function main(k, stage, layer) { 
		createNodes(k, stage, layer); 			
		createEdges(k, stage, layer);

		for(var i = 1; i < trees[k].length; ++i) { 
			for(var j = 0; j < trees[k][i].length; ++j) {
				createEventDrag(trees[k][i][j].viewRect, trees[k][i][j].arrows, layer);	 
			} 
		}		
	} 

	window.onload = function() {
		
	var stage = createStage("tree0", 99 * getClientWidth() / 100,  getClientHeight() / 2);
	var layer = new Kinetic.Layer();
	main(0, stage, layer);

	};
</script></head>
   <body>
      <p>
         <center><font size="18">
               <string> MGRA tree, beta version </string></font></center>
      </p>
      <div id="tree0"></div>
      <div id="gen12" style="display:none;">
         <h3>Chromosomes for 12</h3>&nbsp;1.<a href="#a" title="a">&gt;</a><a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><br>&nbsp;2.<a href="#d" title="d">&gt;</a><a href="#e" title="e">&gt;</a><a href="#f" title="f">&gt;</a><br></div>
      <div id="gen34" style="display:none;">
         <h3>Chromosomes for 34</h3>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#a" title="a">&lt;</a><br>&nbsp;2.<a href="#f" title="f">&gt;</a><a href="#e" title="e">&lt;</a><a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><br></div>
      <div id="gen1" style="display:none;">
         <h3>Chromosomes for 1</h3>&nbsp;1.<a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><a href="#a" title="a">&lt;</a><br>&nbsp;2.<a href="#d" title="d">&gt;</a><a href="#e" title="e">&gt;</a><a href="#f" title="f">&gt;</a><br></div>
      <div id="gen2" style="display:none;">
         <h3>Chromosomes for 2</h3>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#e" title="e">&gt;</a><a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><br>&nbsp;2.<a href="#a" title="a">&gt;</a><a href="#f" title="f">&gt;</a><br></div>
      <div id="gen3" style="display:none;">
         <h3>Chromosomes for 3</h3>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#a" title="a">&lt;</a><br>&nbsp;2.<a href="#f" title="f">&gt;</a><a href="#e" title="e">&lt;</a><a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><br></div>
      <div id="gen4" style="display:none;">
         <h3>Chromosomes for 4</h3>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#a" title="a">&lt;</a><a href="#c" title="c">&lt;</a><a href="#b" title="b">&lt;</a><a href="#e" title="e">&gt;</a><a href="#f" title="f">&lt;</a><br></div>
      <div id="trs12" style="display:none;">
         <h3>Transformations for 12</h3>&nbsp;2.<a href="#d" title="d">&gt;</a><a href="#e" title="e">&gt;</a><span class="end0">h</span>&nbsp;
         
         &nbsp;<span class="end1">t</span><a href="#f" title="f">&gt;</a><br><span class="end0">eh&nbsp;
            </span><span class="end1">ft&nbsp;
            </span><span class="end2">oo&nbsp;
            </span><span class="end3">oo&nbsp;
            </span><br>&nbsp;2.<a href="#d" title="d">&gt;</a><a href="#e" title="e">&gt;</a><span class="end0">h</span>&nbsp;
         <br>&nbsp;3.
         &nbsp;<span class="end1">t</span><a href="#f" title="f">&gt;</a><br><br></div>
      <div id="trs34" style="display:none;">
         <h3>Transformations for 34</h3>&nbsp;1.<a href="#d" title="d">&gt;</a><span class="end1">h</span>&nbsp;
         
         &nbsp;<span class="end0">h</span><a href="#a" title="a">&lt;</a><br>&nbsp;2.<a href="#f" title="f">&gt;</a><a href="#e" title="e">&lt;</a><span class="end3">t</span>&nbsp;
         
         &nbsp;<span class="end2">t</span><a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><br><span class="end0">ah&nbsp;
            </span><span class="end1">dh&nbsp;
            </span><span class="end2">bt&nbsp;
            </span><span class="end3">et&nbsp;
            </span><br>&nbsp;1.<a href="#d" title="d">&gt;</a><span class="end1">h</span>&nbsp;
         
         &nbsp;<span class="end3">t</span><a href="#e" title="e">&gt;</a><a href="#f" title="f">&lt;</a><br>&nbsp;2.<a href="#c" title="c">&lt;</a><a href="#b" title="b">&lt;</a><span class="end2">t</span>&nbsp;
         
         &nbsp;<span class="end0">h</span><a href="#a" title="a">&lt;</a><br><br>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#e" title="e">&gt;</a><span class="end1">h</span>&nbsp;
         
         &nbsp;<span class="end0">h</span><a href="#f" title="f">&lt;</a><br><span class="end0">fh&nbsp;
            </span><span class="end1">eh&nbsp;
            </span><span class="end2">oo&nbsp;
            </span><span class="end3">oo&nbsp;
            </span><br>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#e" title="e">&gt;</a><span class="end1">h</span>&nbsp;
         <br>&nbsp;3.
         &nbsp;<span class="end0">h</span><a href="#f" title="f">&lt;</a><br><br></div>
      <div id="trs1" style="display:none;">
         <h3>Transformations for 1</h3>&nbsp;1.<a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><span class="end0">h</span>&nbsp;
         
         &nbsp;<span class="end1">h</span><a href="#a" title="a">&lt;</a><br><span class="end0">ch&nbsp;
            </span><span class="end1">ah&nbsp;
            </span><span class="end2">oo&nbsp;
            </span><span class="end3">oo&nbsp;
            </span><br>&nbsp;1.<a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><span class="end0">h</span>&nbsp;
         <br>&nbsp;3.
         &nbsp;<span class="end1">h</span><a href="#a" title="a">&lt;</a><br><br>&nbsp;1.
         &nbsp;<span class="end1">t</span><a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><br>&nbsp;3.
         &nbsp;<span class="end3">h</span><a href="#a" title="a">&lt;</a><br><span class="end0">oo&nbsp;
            </span><span class="end1">bt&nbsp;
            </span><span class="end2">oo&nbsp;
            </span><span class="end3">ah&nbsp;
            </span><br>&nbsp;1.<a href="#a" title="a">&gt;</a><span class="end3">h</span>&nbsp;
         
         &nbsp;<span class="end1">t</span><a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><br><br></div>
      <div id="trs2" style="display:none;">
         <h3>Transformations for 2</h3>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#e" title="e">&gt;</a><span class="end3">h</span>&nbsp;
         
         &nbsp;<span class="end2">t</span><a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><br>&nbsp;2.<a href="#a" title="a">&gt;</a><span class="end0">h</span>&nbsp;
         
         &nbsp;<span class="end1">t</span><a href="#f" title="f">&gt;</a><br><span class="end0">ah&nbsp;
            </span><span class="end1">ft&nbsp;
            </span><span class="end2">bt&nbsp;
            </span><span class="end3">eh&nbsp;
            </span><br>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#e" title="e">&gt;</a><span class="end3">h</span>&nbsp;
         
         &nbsp;<span class="end1">t</span><a href="#f" title="f">&gt;</a><br>&nbsp;2.<a href="#a" title="a">&gt;</a><span class="end0">h</span>&nbsp;
         
         &nbsp;<span class="end2">t</span><a href="#b" title="b">&gt;</a><a href="#c" title="c">&gt;</a><br><br></div>
      <div id="trs3" style="display:none;">
         <h3>Transformations for 3</h3>
      </div>
      <div id="trs4" style="display:none;">
         <h3>Transformations for 4</h3>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#a" title="a">&lt;</a><span class="end0">t</span>&nbsp;
         
         &nbsp;<span class="end1">h</span><a href="#c" title="c">&lt;</a><a href="#b" title="b">&lt;</a><a href="#e" title="e">&gt;</a><a href="#f" title="f">&lt;</a><br><span class="end0">at&nbsp;
            </span><span class="end1">ch&nbsp;
            </span><span class="end2">oo&nbsp;
            </span><span class="end3">oo&nbsp;
            </span><br>&nbsp;1.<a href="#d" title="d">&gt;</a><a href="#a" title="a">&lt;</a><span class="end0">t</span>&nbsp;
         <br>&nbsp;2.
         &nbsp;<span class="end1">h</span><a href="#c" title="c">&lt;</a><a href="#b" title="b">&lt;</a><a href="#e" title="e">&gt;</a><a href="#f" title="f">&lt;</a><br><br></div>
      <footer>
         <hr>
         	MGRA 1.0 Â© 2008,09 by Max Alekseyev
         	
      </footer>
   </body>
</html>