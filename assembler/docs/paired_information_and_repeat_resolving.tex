\documentclass[12pt,a4paper,oneside]{article}
\usepackage{afterpage,fullpage,amsmath,amsfonts,amssymb}
\usepackage[cp1251]{inputenc}
\usepackage[english]{babel}
\usepackage{concrete}
\usepackage{euler}
\usepackage{ifthen}
\usepackage{cite}
\usepackage{soul}
\usepackage{listings}
%\usepackage[pdftex]{graphicx}
\usepackage{graphics}
\usepackage{graphicx}

\usepackage{algorithmic}
\usepackage{algorithm}
%\usepackage{cmap}

%\usepackage[T2A]{fontenc}
\usepackage[cp1251]{inputenc}
\newtheorem{problem}{Problem}
\newtheorem{theorem}{Theorem}
\newtheorem{definition}{Definition}
\newtheorem{remark}{Remark}
\newtheorem{lemma}{Lemma}

%%-- \usepackage[14pt]{extsizes}



\begin{document}
\selectlanguage{english}

\begin{center}
Repeat resolving using paired data.
\end{center}
\section{motivation}
  We need to resolve repeats using paired information. In fact, it should be as strong tool, as paired de Bruijn graph is, but without complexity and memory problems of paired de Bruijn graph approach.
Simplification, provided by rectangle graph, can also be done in our terms.  

\section{About paired info}

Assume that we have a graph $G=(V,E)$. 
For given edge $a$ we'll denote it's length as $l_a$.
Given a directed path in graph, we define distance between two edges as directed distance from start vertex of first edge to start vertex of second edge.\\ Directed distance between two vertices $A$ and $B$ in directed path is 
\begin{itemize}
\item
  sum of edge length's, for edges situated between these vertices in path, if $B$ is after $A$ in this directed path
\item
  -distance($B$,$A$) in other case.
\end{itemize}
For each edge $e$, we'll define $start(e)$ and $end(e)$ as start and end vertex of edge $e$ respectivly.
For such graph we define \emph{edge pair} as ordered pair $(a, b)$ where $a \in E$ and $b \in E$.
\emph{Edge pair info} is pair $((a,b), x)$ where $(a,b)$ is edge pair, and $x \in \mathbb{Z}$.
For given constant $d$ and directed path $P$ (from graph $G$), pair info $((a,b), x)$ with positive $x$ is called $d$-edge pair consistent  if there exists directed subpath $P'$ of $P$, such that distance in $P'$ between $a$ and $b$ is $x$ and $x - l_a < d$, $x + l_b > d$.  

\emph{$d$-set of edge pair info} is subset $S$ of set of all possible edge pair info such that there exists a Chinese postman cycle $C$ (possibly not unique), satisfying following conditions:
 $((a, b), x) \in S \Leftrightarrow  ((a, b), x)$ is $d$-consistent with respect to cycle $C$.
  
\subsection{Receiving paired info from reads}
We'll write another text about it.
\section{Main goal}
We want to define what is ``correct'' graph transformation due to paired information, and methods allowing to compare these graph transformations in terms of resulting graph complexity.

\subsection{Correct graph transformation}
For given graph $G=(V, E)$, we'll say that graph $G' = (V', E')$  is \emph{correct ungluing} of $G$ if there exists mappings $f: V' \rightarrow V$ and $g: E' \rightarrow P$ where $P$ is set of all edge paths in $G$
satisfying following conditions:
\begin{enumerate}

\item Edge length in $G'$ must be consistent with $g$ i.e. $\forall a\in E', l_a = l_{(g(a))}$. 

 If $e'\in E'$ we define $\mathop{start_e}(e')$ as first edge from path $g(e')$
 and $\mathop{end_e}(e')$ as last edge from path $g(e')$.


\item $\forall (v_1, v) = \mathop{start_e}((v_1', v_2')) \quad v_1 = f(v_1')$
\item $\forall (v_1, v_2) = \mathop{end_e}((v_1', v_2')) \quad v_2 = f(v_2')$
\end{enumerate}
For given directed path $P' = (e'_0, \ldots, e`_n)$ in $G' $ we'll define \emph{decoding} of this path as $(g(e'_0), \ldots, g(e'_n))$ and denote it as $dec(P')$.
For given $d$-set of edge pair info and Chinese postman cycle $C$, $C$ is \emph{valid} cycle iff $((a, b), x) \in S \leftrightarrow  ((a, b), x)$ is $d$-consistent in respect to cycle $C$.

We say that cycle $C' \in G'$ is \emph{valid} if $dec(C')=C$, $C$ is valid cycle in $G$.
  
If $dec(P)$ is a bijection between valid cycles in $G$ and $G'$, we'll say that correct ungluing $G'$ is \emph{consistent} to $d$-set of paired info $S$.
We'll call such ungluing \emph{honest}.

\subsection{Informal reformulation}
Every valid Chinese postman cycle in $G$ corresponds to consistent with graph and paired information variant of genome. So, our condition means that after our transformation, every possibility for genome must be preserved, and no possible genomic cycle will transform to two different ones.

Also, it can be simply reformulated for non-cyclic genome.

\subsection{Inexact distances}

For given $\Delta$ we can slightly change our assuming about $d$-set of edge pair info.  We say that $\{(a_i, b_i), x_i\}$ is \emph{$(d, \Delta)$-set of edge pair info} if there exists $\{\delta_i\}$ where $\forall i \quad |\delta_i|\leq \Delta$ and $\{(a_i, b_i), x_i+\delta_i\}$ is $d$-set of edge pair info.

\subsection{Graph complexity estimation - still under discussion!}
\begin{problem}
   Having two honest ungluings of one graph $G$ with the same $d$-set of paired info,we want to define which one is somehow``better''.
\end{problem}
  For every vertex $v \in V'$, we'll define \emph{vertex incomming-outgoing set} (and denote it as $S_v$)  as $\{(a, b)| a\in E, b\in E\}$, $(a, b)$ satisfies following conditions:
\begin{enumerate}
 \item $\exists v_1 \in V' : (v_1, v) \in E', \mathop{end}(v_1, v) = a$
 \item $\exists v_2 \in V' : (v, v_2) \in E', \mathop{start}(v, v_2) = b$
\end{enumerate}
 
\emph{Graph incomming-outgoing set} is $\bigcup_v S_v$
\emph{Measure of complexity} for $G'$ is size of $G'$ graph incomming-outgoing set.
There are many other possible measure, for example, minus sum of all edges length.

\section{Connection with rectangle graph}

\begin{definition}
  \emph{Vertex pair info} is a triple $(A, B, x)$, where $A$ and $B$ are vertices and $x \in \mathbb{Z}$ 
\end{definition}
\begin{definition}
  \emph{Vertex-edge pair info} is a triple $(A, b, x)$, where $A$ is vertex, $b$ is edge and $x \in \mathbb{Z}$ 
\end{definition}
Note: labels in rectangle graph can be considered as vertex pair info.

Let's consider rectangle graph processing. 
There are three steps in it (without less of generality, we'll contract blue edges):
\begin{enumerate}
\item Building all possible rectangles.
\item Gluing vertices with same labels.
\item Contracting blue edges.
\end{enumerate}
Let's denote the resulting graph after all three steps as $G_r = (V_r,E_r)$ and result of first two steps as $G_{rb} = (V_{rb}, E_{rb})$. Each vertex $v_{rb}$ from $V_{rb}$ has a label that are vertex pair info $(A(v_{rb}), B(v_{rb}), x(v_{rb}))$. First element of such triple ($A(v_{rb})$) we call \emph{first mark} of vertex $v_{rb}$ and denote it $\mathop{fm}(v_{rb})$. 

Since contracting of blue edges is gluing operation, there exists a partition of $V_{rb}$ into family of disjoint subsets $\{H_{rb}(v_r)\}_{v_r\in V_r}$ such that all vertex from $H_{rb}(v_r)$ glued into $v_r$. 
For given vertex $v_r \in V_r$, let's consider $H_{rb}(v_r)$. Since two vertices from $G_{rb}$ connected by blue edge have same first mark, we can define mapping $f: V_r\rightarrow V$ by following equation:
$$f(v_r)=\mathop{fm}(v_{rb}), \text{ where }v_{rb}\text{ any element of } H_{rb}(v_r).$$

Each edge of $G_{r}$ has label from $E$ by construction. So this labeling provides us mapping $g:E_{r}\rightarrow E$. 

The conditions on $f$ and $g$ from definition of correct ungluing are satisfied by construction of rectangle graph.

\begin{remark}
  By construction, every vertex in one blue-connected component of $G_{rb}$ has the same vertex $V \in G$ as first mark.
\end{remark}

\begin{remark}
 The third step (contracting blue edges) is equivalent to constructing a graph with blue-connected components of $G_{rb}$ as vertex set. Two vertices in new graph a connected with edge labeled $e$ iff in corresponing connected components of $G_{rb}$ contained two vertices, connected with edge labeled $e$.  
\end{remark}


For given compressed de Bruijn graph $G=(V,E)$ and $d$-set of edge pair info $P$ 
we say that vertex pair info $(A, B, x)$ is \emph{obtained} from $P$ if there exists edge pair info $((a,b),y)$ such that:
\begin{itemize}
\item[either] $a$ incoming edge for $A$, $b$ incoming edge for $B$ and $x=y-l_a+l_b$, 
\item[either] $a$ outgoing edge for $A$, $b$ incoming edge for $B$ and $x=y+l_b$, 
\item[either] $a$ incoming edge for $A$, $b$ outgoing edge for $B$ and $x=y-l_a$, 
\item[either] $a$ outgoing edge for $A$, $b$ outgoing edge for $B$ and $x=y$. 
\end{itemize} 

For given compressed de Bruijn graph $G=(V,E)$ and $d$-set of edge pair info $P$ 
we say that vertex-edge pair info $(A, b, x)$ is \emph{obtained} from $P$ if there exists edge pair info $((a,b),y)$ such that:
\begin{itemize}
\item[either] $a$ incoming edge for $A$ and $x=y-l_a$, 
\item[either] $a$ outgoing edge for $A$ and $x=y$. 
\end{itemize} 
We'll denote such edge pair info $((a, b), y)$ (possibly not unique) as \emph{precursor} of vertex-edge pair info $(A, b, x)$.

Two vertex-edge pairs $(V,a,x)$ and $(V,b,y)$ are called \emph{adjacent} if $a$ and $b$ have at least one common vertex in graph $G$ and distances from $V$ to common vertices of $a$ and $b$, obtained from $(V,a,x)$ and from $(V,b,y)$, are same. 


We denote set of all vertex-edge pair info obtained from $P$ as $P_v$.
For vertex $Z$, $P_v(Z) = \{(A, b, x)|(A, b, x) \in P_v; A = Z\}$.
 
Now we can define \emph{rectangle split operation}:
\begin{definition}
For given vertex $Z \in V$ rectangle split operation consisting following steps:
\begin{enumerate}
\item Part $P_v(Z)$ into equivalence classes by transitive closure of adjacency relationship: $P_v(Z) = \bigcup C_i$. 
\item For each such class crate vertex $Z_i$.
\item For each precursor $((a, b), y)$ of each vertex-edge pair info's $(A, b, x) \in C_i$,  create a copy $a_i$ of edge $a$, replacing all occurences of $Z$ in $(start(a), end(a))$ to $Z_i$  
\item For each precursor $((a, b), y)$ of each vertex-edge pair info's $(A, b, x) \in C_i$, replace $((a, b), y)$ in $P$ with $((a_i, b), y)$
\item Remove $Z$ with all it's incomming and outgoing edges.
\end{enumerate} 
\end{definition} i
\begin{theorem}
  After applying rectangle split operation to each vertex of initial graph $G$ in any order we'll receive a graph $G' = (V', E')$, such that there exists one-to-one mapping from $(V', E')$ to $(V_r, E_r)$ and this mapping respects labeling.
\end{theorem}
\begin{remark}
 Initial graph $G$ is also correct ungluing of itself, with identical $f$ and $g$. We'll iterativelly modify $f$ and $g$ in each rectange split operation:
$f(Z_i):= f(Z)$, $g(a_i):= g(a)$
 It's evident, that after each rectangle split ungluing conditions (from definition of correct ungluing) on $f$ and $g$ are still satisfied.

\end{remark}

\subsection{Sketch of proof}
Let's fix some order of rectangle split operations,
While applying rectangle split operations to each vertex except $Z$, we can somehow modify $P$, but the set $P_v(Z)$ stays constant (because vertex-edge paired info, obtained from removed edge $e$ can be still obtained from an edge $e_i$ for some $i$). By construction of rectangle graph, there is a one-one mapping from $C_i$(and so from $Z_i$) to set of all blue-connected components, having $Z$ as first vertex in label. Let's consider union of this mappings for all vertices $Z \ in V$. It's also provides us a mapping on edges (SHURIK!!!). 

\begin{theorem}
  In terms of Son's paper, result of his gluing procedure and contracting blue edges is a honest ungluing of initial graph $G$. 
\end{theorem}
\begin{theorem}
  In terms of Son's paper, result of his gluing procedure and contracting blue edges has measure of complexity, which is less or equal to measure of complexity of initial graph $G$. 
\end{theorem}






\section{Our ideas}

We try to define some ``split'' operation. After every step of this split operation, started from $G_0$, we will have graph $G_m$, which is a honest ungluing of initial graph $G_0$. And measure of complexity of $G_m$ is less or equal than measure of complexity of $G_{m-1}$.   

\subsection{Simple split operation}

We start from graph $G_0$ and {$d$-set of edge pair info} $S$.
We say that edge \emph{$e=(v_1, v_2)$ followed by $e'=(v_1', v_2')$ with respect to $S$} iff $v_2 = v_1'$ and 
\begin{itemize}
\item[either ] there exist edge $t$, and $x \in \mathbb{N}  $ such that $((e,t),x) \in S$ and $((e',t),x-l_e)\in S$; 
\item[either ] there exist two edge $t=(w_1,w_2)$ and $t'=(w_2, w_3)$, and $x \in \mathbb{N}$ such that $((e,t),x) \in S$ and $((e',t'),x-l_e+l_t) \in S$. 
\end{itemize}
We say that edge \emph{$e$ close to $e'$ with respect to $S$} iff either $e$ followed by $e'$ with respect to $S$, either $e'$ followed by $e$ with respect to $S$.
For each vertex $A$ we consider vertex incomming-outgoing set $S_A$ (defined above). We can divide $S_A$ in clusters $C_j$ due to transitive closure of \emph{close with respect to $S$} relationship, i.e. we build maximum as possible $C_j$ disjoint subsets of $S_A$ such that $S_A=\bigcup C_j$ and if two edge from $S_A$ are close with respect to $S$ than they belongs to one $C_j$.  

Now we can define split operation for vertex $A$. We delete vertex $A$ and add new vertices $(A, C_j)$. For every incoming or outgoing $e$ edge we reroute it into vertex $(A, C_j)$ if $e\in C_j$. 


%Note, that we do not create ``new'' edges (there is evident bijection between edge sets in original and resulting graph), but split some vertices making graph simpler. 

Such split operation not increase graph complexity measure defined above. 

\section{Details about real implementation}
We'll have to ignore low confirmed information about distance between edges to avoid chimeric pairs. Also, it may turn out that after out resolving we'll need to do tip clipping again because of erroneous connections.
In case of low coverage of genome with right elements of mate-pairs we'll possibly have to consider set $T_i$ instead of $S_i$, where $T_i$ contains every edge, such that it distance to $S_i$ is less than some cutoff $d$.

\section{connected ideas}
\subsection{insert-length distribution specifing}
We can use mate-pairs aligning the same edge to specify insert-length distribution.
\subsection{complicated repeat resolving}
Next step is to resolve repeats using distances distribution on neighbouring edge (to divide sum of two close normal distributions with one)w

\end{document}

%Old stuff
 

%Imperfect 
%Fix some k.
%We define GEN, as ordered set of k-mer. This set can be represented as graph where vertices is position $i$ in GEN, labeled by k-mer on this position. Edges in this graph is $(i,i+1)$. Later if we say GENOME, we mean this graph. 

%We can define different gluing operation for GENOME. If we glue all vertices labeled with identical k-mers we got de Bruijn graph.

%If we have some glued graph we can want to obtain original graph. Lets try to do it by splitting glued vertices and edges. If we try to do this we found that with out new information it cant be done. As this new information we consider set of edge pair infos. For this type of infos we try to define some splitting rules.   

%  De bruijn group provides us compressed graph and paired data - set of somehow ordered distances between edge pairs, confirmed by reads. 
%We'll provide de-bruijn graph with some repeat resolving.
%For each edge(of compressed de bruijn graph) $x$ we 'll consider set $S_x: \forall y\in E,  y\in S_x \iff $ we have at least one mate-read such that left read in pair aligns to $x$ and right to $y$.

